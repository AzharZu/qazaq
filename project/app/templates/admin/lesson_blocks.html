{% extends "admin/admin_base.html" %}
{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-1">Блоки урока "{{ lesson.title }}"</h3>
        <p class="text-muted mb-0">Всего: {{ lesson.blocks|length }}</p>
    </div>
    <div>
        <a class="btn btn-primary" href="/admin/lesson/{{ lesson.id }}/blocks/add">Добавить блок</a>
        <a href="/admin/module/{{ lesson.module_id }}/lessons" class="btn btn-outline-secondary ms-2">Назад</a>
    </div>
</div>
<div class="card shadow-sm">
    <div class="list-group list-group-flush" id="blocks-list">
        {% for block in lesson.blocks %}
        <div class="list-group-item d-flex align-items-center justify-content-between gap-2 draggable-block" draggable="true" data-id="{{ block.id }}" data-order="{{ block.order }}">
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-light text-dark border">#{{ block.order }}</span>
                <span class="badge bg-secondary">{{ block.block_type }}</span>
                <span class="text-muted small">ID {{ block.id }}</span>
            </div>
            <div class="d-flex align-items-center gap-1">
                <a class="btn btn-sm btn-outline-primary" href="/admin/block/{{ block.id }}/edit">Редактировать</a>
                <form method="post" action="/admin/block/{{ block.id }}/delete" class="d-inline" onsubmit="return confirm('Удалить блок?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>
    const list = document.getElementById("blocks-list");
    let dragEl = null;
    list?.addEventListener("dragstart", (e) => {
        dragEl = e.target.closest(".draggable-block");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", "");
        dragEl.classList.add("dragging");
    });
    list?.addEventListener("dragend", () => {
        dragEl?.classList.remove("dragging");
        dragEl = null;
    });
    list?.addEventListener("dragover", (e) => {
        e.preventDefault();
        const after = Array.from(list.querySelectorAll(".draggable-block:not(.dragging)")).find((el) => {
            const box = el.getBoundingClientRect();
            return e.clientY < box.top + box.height / 2;
        });
        if (!dragEl) return;
        if (after) list.insertBefore(dragEl, after);
        else list.appendChild(dragEl);
    });
    list?.addEventListener("drop", async () => {
        const ids = Array.from(list.querySelectorAll(".draggable-block")).map((el, idx) => ({
            id: el.dataset.id,
            order: idx + 1,
        }));
        for (const item of ids) {
            const form = new FormData();
            form.append("new_order", item.order);
            await fetch(`/admin/block/${item.id}/move-to`, { method: "POST", body: form, credentials: "include" });
        }
        ids.forEach((item, idx) => {
            const el = list.querySelector(`.draggable-block[data-id="${item.id}"] .badge`);
            if (el) el.textContent = `#${idx + 1}`;
        });
    });
</script>
{% endblock %}
