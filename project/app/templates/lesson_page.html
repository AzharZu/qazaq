{% extends "base.html" %}
{% block content %}
<div class="lesson-hero mb-3 d-flex justify-content-between align-items-start flex-wrap gap-3">
    <div>
        <p class="eyebrow mb-1">{{ lesson.module.course.name }} / {{ lesson.module.name }}</p>
        <h2 class="fw-bold">{{ lesson.title }}</h2>
        <p class="text-muted mb-1">{{ lesson.description }}</p>
        <div class="d-flex gap-2 flex-wrap">
            <span class="pill">⏱ {{ lesson.estimated_time or 10 }} мин</span>
            <span class="pill">{{ lesson.difficulty or "easy" }}</span>
        </div>
    </div>
    <div class="text-end">
        {% if progress_status %}
        <span class="status-badge success text-uppercase">{{ progress_status }}</span>
        {% endif %}
        <div class="small text-muted">Flashcards · Quiz · Grammar · Audio</div>
    </div>
</div>

<div class="vstack gap-3">
{% for block in lesson.blocks %}
    {% if block.block_type == "theory" %}
    <div class="lesson-block">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="block-label">Текстовый блок</span>
            <span class="status-badge info">TextBlock</span>
        </div>
        <h5 class="fw-bold">{{ block.content.title }}</h5>
        <p class="mb-0 text-muted">{{ block.content.text }}</p>
    </div>
    {% elif block.block_type == "example" %}
    <div class="lesson-block">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="block-label">Примеры</span>
            <span class="status-badge info">Examples</span>
        </div>
        <div class="table-responsive">
            <table class="table table-borderless mb-0 align-middle">
                <thead class="table-light">
                    <tr><th>KZ</th><th>RU</th></tr>
                </thead>
                <tbody>
                {% set example_rows = block.content.rows if block.content.rows is defined else block.content.examples %}
                {% for row in example_rows %}
                    <tr><td class="fw-semibold">{{ row.kz }}</td><td class="text-muted">{{ row.ru }}</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif block.block_type == "flashcards" %}
    {% set selected_ids = block.content.flashcard_ids if block.content.flashcard_ids is defined else [] %}
    <div class="lesson-block">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="block-label">Flashcard block</span>
            <span class="status-badge info">FlipCard</span>
        </div>
        <div class="row g-3">
            {% for card in lesson.flashcards if not selected_ids or card.id in selected_ids %}
            <div class="col-md-4">
                <div class="flashcard-mini h-100">
                    <div class="fw-bold fs-5">{{ card.front }}</div>
                    <div class="text-muted">{{ card.back }}</div>
                    <button type="button" class="btn btn-sm btn-outline-dark mt-2" onclick="startPronunciation('{{ card.front }}', 'pronunciation-result-{{ card.id }}')">Произнеси</button>
                    <p id="pronunciation-result-{{ card.id }}" class="small text-muted mb-0 mt-1"></p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% elif block.block_type == "quiz" %}
    {% set selected_ids = block.content.quiz_ids if block.content.quiz_ids is defined else [] %}
    <div class="lesson-block">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="block-label">Quiz block</span>
            <span class="status-badge info">Multiple-choice</span>
        </div>
        {% for quiz in lesson.quizzes if not selected_ids or quiz.id in selected_ids %}
        <div class="mb-3 quiz-card" data-correct="{{ quiz.correct_option }}">
            <div class="fw-semibold mb-2">{{ quiz.question }}</div>
            <div class="vstack gap-2 quiz-options">
                {% for opt in quiz.options %}
                <label class="quiz-option">
                    <input type="radio" name="quiz-{{ quiz.id }}" value="{{ loop.index0 }}">
                    <span>{{ opt }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <button class="btn btn-outline-dark btn-sm quiz-check">Проверить</button>
                <div class="small text-muted quiz-feedback"></div>
            </div>
            {% if quiz.explanation %}<div class="text-muted small mt-2">{{ quiz.explanation }}</div>{% endif %}
        </div>
        {% endfor %}
    </div>
    {% elif block.block_type == "story" %}
    <div class="lesson-block">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="block-label">Ситуация</span>
            <span class="status-badge info">Dialog</span>
        </div>
        {% if block.content.dialogue is defined %}
            {% for line in block.content.dialogue %}
            <div class="d-flex mb-1">
                <div class="fw-semibold me-2">{{ line.speaker }}:</div>
                <div>{{ line.line }}</div>
            </div>
            {% endfor %}
        {% else %}
            <p class="fw-semibold mb-1">{{ block.content.situation }}</p>
            <p class="mb-2">{{ block.content.question }}</p>
            <div class="vstack gap-2">
                {% for opt in block.content.options %}
                <div class="quiz-option">
                    <span>{{ opt }}</span>
                    {% if loop.index0 == block.content.correct_index %}<span class="status-badge success ms-auto">верный</span>{% endif %}
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
    {% elif block.block_type == "dragdrop" %}
    <div class="lesson-block">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="block-label">Drag & Drop</span>
            <span class="status-badge info">Order</span>
        </div>
        <p class="fw-semibold">{{ block.content.task }}</p>
        <div class="row g-2">
            <div class="col-md-6">
                <div class="flashcard-mini">
                    <div class="small text-muted mb-1">Элементы</div>
                    {% for part in block.content.parts %}
                    <div class="pill d-inline-flex me-1 mb-1">{{ part }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="flashcard-mini">
                    <div class="small text-muted mb-1">Правильный порядок</div>
                    {% for item in block.content.correct_order %}
                    <div class="pill d-inline-flex me-1 mb-1">{{ item }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% elif block.block_type == "mascot_tip" %}
    {% set mascot = block.content %}
    {% include "components/mascot_tip.html" %}
    {% elif block.block_type == "pronunciation" %}
    <div class="lesson-block">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="block-label">Произнеси</span>
            <span class="status-badge info">AudioBlock</span>
        </div>
        <div class="row g-2">
            {% for word in block.content.words %}
            {% set rid = "pronunciation-word-" ~ loop.index %}
            <div class="col-md-4">
                <div class="audio-block h-100">
                    <div class="fw-semibold fs-5">{{ word }}</div>
                    <div class="audio-wave"></div>
                    <button type="button" class="btn btn-sm btn-outline-dark" onclick="startPronunciation('{{ word }}', '{{ rid }}')">Айт / Произнеси</button>
                    <p id="{{ rid }}" class="small text-muted mb-0 mt-2"></p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% elif block.block_type == "image" %}
    <div class="lesson-block">
        <div class="block-label mb-2">Изображение</div>
        <img src="{{ block.content.url }}" class="w-100 rounded-3" alt="image block">
    </div>
    {% else %}
    <div class="lesson-block">
        <div class="block-label mb-2">Блок {{ block.block_type }}</div>
        <pre class="mb-0 small text-muted">{{ block.content | tojson }}</pre>
    </div>
    {% endif %}
{% endfor %}
</div>

{% if user %}
    <div class="mt-4 lesson-footer">
        {% if progress_status == "done" %}
        <span class="pill">Урок завершён ✓</span>
        {% elif progress_status %}
        <span class="text-muted">Статус: {{ progress_status }}</span>
        {% endif %}
        <form method="post" action="/lesson/{{ lesson.id }}/complete" class="ms-auto">
            <button class="btn btn-primary" type="submit">Завершить урок</button>
        </form>
    </div>
{% endif %}
<script src="{{ url_for('static', path='js/lesson.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".quiz-card").forEach((card) => {
        const correctIndex = Number(card.dataset.correct);
        const feedback = card.querySelector(".quiz-feedback");
        card.querySelector(".quiz-check")?.addEventListener("click", (e) => {
            e.preventDefault();
            const checked = card.querySelector("input[type='radio']:checked");
            if (!checked) {
                if (feedback) feedback.textContent = "Выберите вариант";
                return;
            }
            const selected = Number(checked.value);
            const ok = selected === correctIndex;
            if (feedback) {
                feedback.textContent = ok ? "Верно" : "Неверно, попробуйте ещё раз";
                feedback.className = `small quiz-feedback ${ok ? "text-success" : "text-danger"}`;
            }
        });
    });
});
</script>
{% endblock %}
