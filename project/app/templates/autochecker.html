{% extends "base.html" %}
{% block content %}
<section class="page-section">
    <div class="autochecker-shell card-plate shadow-soft">
        <div class="d-flex flex-column gap-2">
            <div>
                <div class="eyebrow text-uppercase text-muted">AutoChecker</div>
                <h1 class="display-title fs-2 mb-1">–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–µ–∫—Å—Ç–∞</h1>
                <p class="lead-text mb-0">–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∏ –¥–∞—ë—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—è –≤–∞—Å.</p>
            </div>
            {% if error %}<div class="alert alert-danger mb-0">{{ error }}</div>{% endif %}
            <form method="post" class="vstack gap-3 position-relative">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">–£—Ä–æ–≤–µ–Ω—å</label>
                        <select name="level" class="form-select">
                            {% set lvl = (level or 'A2') %}
                            {% for opt in ['A1','A2','B1','B2'] %}
                                <option value="{{ opt }}" {% if opt == lvl %}selected{% endif %}>{{ opt }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <p class="small text-muted mb-0">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –ò–ò –±—ã–ª –º—è–≥—á–µ –∏–ª–∏ —Å—Ç—Ä–æ–∂–µ.</p>
                    </div>
                </div>
                <div class="position-relative">
                    <label class="form-label fw-semibold">–¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                    <textarea id="autochecker-text" name="user_text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º –∏–ª–∏ —Ä—É—Å—Å–∫–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏‚Ä¶" class="form-control"
                              style="min-height: 240px; background: #f7f7f7; border: 1px solid #d0d0d0; border-radius: 12px; padding: 16px;">{{ input_text }}</textarea>
                    <button type="button" class="voice-btn" id="mic-btn">üé§ –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å</button>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="cta-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –ò–ò</button>
                </div>
            </form>
        </div>
    </div>
</section>

{% if result %}
<section class="page-section" aria-live="polite">
    <div class="autochecker-shell card-plate shadow-soft">
        <div class="row g-3 align-items-stretch mb-3">
            <div class="col-lg-7">
                <div class="score-card h-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</span>
                        <span class="fw-bold">{{ result.grammar_score }}/10</span>
                    </div>
                    <div class="score-bar mb-3">
                        <div class="score-bar-fill" style="width: {{ (result.grammar_score or 0) * 10 }}%"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold">–õ–µ–∫—Å–∏–∫–∞</span>
                        <span class="fw-bold">{{ result.vocabulary_score }}/10</span>
                    </div>
                    <div class="score-bar">
                        <div class="score-bar-fill" style="width: {{ (result.vocabulary_score or 0) * 10 }}%"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="mentor-card h-100">
                    <div class="fw-semibold mb-2">Qazaq Mentor –≥–æ–≤–æ—Ä–∏—Ç:</div>
                    <p class="mb-0">{{ mentor_tip }}</p>
                </div>
            </div>
        </div>

        <div class="ai-card mb-3">
            <div class="fw-semibold mb-2">–í–∞—à —Ç–µ–∫—Å—Ç —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –æ—à–∏–±–æ–∫</div>
            <div class="annotated-box" aria-live="polite">
                {{ result.annotated_html | safe }}
            </div>
        </div>

        <div class="ai-card mb-3">
            <div class="fw-semibold mb-2">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏</div>
            {% if result.errors %}
                <div class="vstack gap-2">
                    {% for item in result.errors %}
                        <div class="error-card">
                            <div class="small text-muted mb-1">–§—Ä–∞–≥–º–µ–Ω—Ç:</div>
                            <div class="fw-semibold mb-1">{{ item.fragment }}</div>
                            <div class="small text-muted mb-1">–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:</div>
                            <div class="mb-1">{{ item.explanation }}</div>
                            <div class="small text-muted mb-1">–ö–∞–∫ –ª—É—á—à–µ:</div>
                            <div class="mb-0">{{ item.suggestion }}</div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="mb-0 text-muted">–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
            {% endif %}
        </div>

        <div class="ai-card mb-3">
            <div class="fw-semibold mb-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
            {% if result.recommendations %}
                <ul class="mb-0 ps-3">
                    {% for rec in result.recommendations %}
                        <li>{{ rec }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mb-0 text-muted">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–µ—Ç.</p>
            {% endif %}
        </div>

        <div class="ai-card">
            <div class="fw-semibold mb-2">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–µ–∫—Å—Ç–∞</div>
            <div class="annotated-box" style="background:#f5f5f5;">{{ result.improved_text or "‚Äî" }}</div>
            <div class="text-muted small mt-2">–≠—Ç–æ –ª–∏—à—å –≤–∞—Ä–∏–∞–Ω—Ç. –ú–æ–∂–µ—Ç–µ –Ω–µ —Å–æ–≥–ª–∞—à–∞—Ç—å—Å—è –∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø–æ-—Å–≤–æ–µ–º—É.</div>
        </div>
    </div>
</section>
{% endif %}

<script>
(function() {
    const textarea = document.getElementById("autochecker-text");
    const micBtn = document.getElementById("mic-btn");
    if (!textarea || !micBtn) return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        micBtn.addEventListener("click", () => alert("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ."));
        return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "ru-RU";
    recognition.interimResults = false;
    recognition.continuous = false;
    let listening = false;

    const setState = (active) => {
        listening = active;
        micBtn.classList.toggle("listening", active);
        micBtn.textContent = active ? "–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å‚Ä¶" : "üé§ –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å";
    };

    recognition.onresult = (event) => {
        if (!event.results || !event.results[0] || !event.results[0][0]) return;
        const spoken = event.results[0][0].transcript;
        textarea.value = (textarea.value ? textarea.value + " " : "") + spoken;
    };
    recognition.onerror = () => setState(false);
    recognition.onend = () => setState(false);

    micBtn.addEventListener("click", () => {
        if (listening) {
            recognition.stop();
            return;
        }
        try {
            setState(true);
            recognition.start();
        } catch (err) {
            console.error(err);
            setState(false);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏.");
        }
    });
})();
</script>
{% endblock %}
