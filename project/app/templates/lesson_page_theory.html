{% extends "base.html" %}
{% block content %}
<div class="lesson-band mb-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 justify-content-between">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="nav-chip text-dark">Урок: {{ lesson.title }}</span>
        </div>
        <div class="flex-grow-1 mx-md-4">
            <div class="progress progress-slim mb-1">
                <div class="progress-bar" role="progressbar" style="width: {{ course_progress }}%;"></div>
            </div>
        </div>
        <div class="small text-muted">{{ course_progress }}%</div>
    </div>
</div>

<section class="page-section">
    <div class="d-flex justify-content-start mb-3">
        <a href="/course/{{ lesson.module.course.slug }}/module/{{ lesson.module.id }}" class="btn-ghost text-decoration-none text-dark">Назад</a>
    </div>

    <h2 class="fw-bold mb-4">Теория</h2>

    <div class="placeholder-lg d-flex align-items-center justify-content-center mb-4">
        <span class="fs-3 text-muted">▶︎</span>
    </div>

    {% set blocks = lesson.blocks or [] %}
    {% set theory_block = blocks | selectattr('block_type', 'equalto', 'theory') | first %}
    {% set example_block = blocks | selectattr('block_type', 'equalto', 'example') | first %}

    <div class="card-plate mb-4">
        <div class="fw-semibold mb-2">{{ theory_block.content.title if theory_block and theory_block.content.title is defined else lesson.title }}</div>
        <p class="mb-3">{{ theory_block.content.text if theory_block else lesson.description }}</p>
        {% if theory_block and theory_block.content.points is defined %}
        <ul class="mb-0">
            {% for point in theory_block.content.points %}
            <li>{{ point }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="card-plate mb-4">
        <div class="fw-semibold mb-2">Примеры</div>
        {% if example_block %}
            {% set example_rows = example_block.content.rows if example_block.content.rows is defined else example_block.content.examples if example_block.content.examples is defined else [] %}
            {% if example_rows %}
            <ul class="mb-0">
                {% for row in example_rows %}
                {% if row.kz is defined and row.ru is defined %}
                <li>{{ row.kz }} — {{ row.ru }}</li>
                {% else %}
                <li>{{ row }}</li>
                {% endif %}
                {% endfor %}
            </ul>
            {% else %}
            <p class="mb-0">{{ example_block.content.text if example_block.content.text is defined else "Добавьте примеры в блоке урока." }}</p>
            {% endif %}
        {% else %}
            <p class="mb-0 text-muted">Примеры появятся здесь.</p>
        {% endif %}
    </div>

    <div class="d-flex justify-content-end">
        <a href="/lesson/{{ lesson.id }}?view=flashcards" class="btn btn-dark">Перейти к флэш-карточкам</a>
    </div>
</section>
{% endblock %}
