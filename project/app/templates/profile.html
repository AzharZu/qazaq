{% extends "base.html" %}
{% block content %}
<section class="page-section profile-shell">
    <div class="d-flex justify-content-start mb-3">
        <a href="/" class="btn-ghost text-decoration-none">← Домой</a>
    </div>
    <h2 class="fw-bold text-center mb-4">Профиль</h2>

    <div class="card-plate mb-4">
        <div class="row g-4 align-items-center">
            <div class="col-md-4 text-center">
                <div class="avatar-circle mb-2">{{ (user.full_name or user.email)[0]|upper if user and (user.full_name or user.email) else "U" }}</div>
                <div class="fw-semibold">{{ user.full_name if user.full_name is defined and user.full_name else "Фамилия Имя" }}</div>
                <div class="text-muted small mb-2">{{ user.email }}</div>
                <button class="btn btn-outline-dark w-100">Редактировать профиль</button>
            </div>
            <div class="col-md-8">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="widget streak-widget h-100">
                            <div class="small fw-semibold">StreakWidget</div>
                            <div class="display-6 fw-bold mb-0">7</div>
                            <div class="small">дней подряд</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="widget daily-goal h-100">
                            <div class="small fw-semibold">DailyGoalWidget</div>
                            <div class="display-6 fw-bold mb-0">20 мин</div>
                            <div class="small">Осталось 8 мин</div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="profile-card p-3 profile-progress">
                            <div class="fw-semibold mb-2">Мой прогресс</div>
                            <div class="small">Курс: {{ progress.course_title or (course.name if course else '') }} — {{ progress.percent }}%</div>
                            <div class="small">Текущий уровень: {{ user.level or "A0" }}</div>
                            <div class="small">Пройдено уроков: {{ progress.completed_lessons }} из {{ progress.total_lessons }}</div>
                            <div class="progress progress-slim mt-2">
                                <div class="progress-bar" role="progressbar" style="width: {{ progress.percent }}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        {% if word_of_week %}
    <div class="profile-card p-4 mb-4">
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
            <div>
                <div class="small text-muted">Слово недели</div>
                <div class="fw-bold fs-4">{{ word_of_week.word.word if word_of_week.word else "" }}</div>
                <div class="text-muted">{{ word_of_week.word.translation if word_of_week.word else "" }}</div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-dark" id="week-play-profile" data-week-audio="{{ word_of_week.word.word if word_of_week.word else '' }}">▶ Озвучить</button>
                <form action="/vocabulary/add/{{ word_of_week.word_id }}" method="post" class="m-0">
                    <button class="btn btn-primary">Добавить в словарь</button>
                </form>
                <a class="btn btn-outline-dark" href="/vocabulary/game/repeat?word_id={{ word_of_week.word_id }}">Мини-игра</a>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="profile-card p-3 h-100">
                <div class="fw-semibold mb-3">Статистика словаря</div>
                {% for course, count in vocab_stats.per_course.items() %}
                    {% set percent = (count / vocab_stats.total * 100) if vocab_stats.total else 0 %}
                    <div class="small mb-1">{{ course }} — {{ count }}</div>
                    <div class="progress progress-slim mb-2">
                        <div class="progress-bar" role="progressbar" style="width: {{ percent|int }}%;"></div>
                    </div>
                {% else %}
                    <div class="text-muted small">Пока нет слов.</div>
                {% endfor %}
                <div class="small text-muted mt-2">Мини-игры: средний успех {{ vocab_stats.avg_success }}%</div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="profile-card p-3 h-100">
                <div class="fw-semibold mb-2">Сложные слова</div>
                <div class="vstack gap-2">
                    {% for w in vocab_stats.hardest %}
                    <div class="badge-soft d-flex justify-content-between">
                        <span>{{ w.word }} — {{ w.translation }}</span>
                        <span class="small text-muted">Ошибок: {{ w.wrong_attempts }}</span>
                    </div>
                    {% else %}
                    <div class="text-muted small">Ошибочных слов пока нет.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="profile-card p-3 h-100">
                <div class="fw-semibold mb-2">Пройденные модули</div>
                <div class="vstack gap-2">
                    {% for item in modules_list %}
                    <div class="badge-soft w-100 text-center">{{ item }}</div>
                    {% else %}
                    <div class="text-muted small">Модулей пока нет.</div>
                    {% endfor %}
                </div>
                <div class="fw-semibold mt-3 mb-2">Пройденные уроки</div>
                <div class="vstack gap-2">
                    {% for lesson_title in lessons_list %}
                    <div class="badge-soft w-100 text-center">{{ lesson_title }}</div>
                    {% else %}
                    <div class="text-muted small">Уроков с статусом «done» пока нет.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="profile-card p-3 h-100">
                <div class="fw-semibold mb-2">AutoChecker</div>
                <div class="text-muted small mb-3">Авточекер — ИИ-инструмент, который находит и подсвечивает ошибки в тексте, не исправляя их</div>
                <div class="placeholder-box mb-3" style="height: 120px;"></div>
                <a class="btn btn-outline-dark text-decoration-none d-inline-block" href="/autochecker">Перейти</a>
            </div>
        </div>
    </div>

    <div class="text-center">
        <a class="btn btn-primary px-4 text-decoration-none d-inline-block" href="/vocabulary">Мой словарь</a>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/vocabulary.js') }}?v=1" defer></script>
<script>
    const weekProfileBtn = document.getElementById("week-play-profile");
    if (weekProfileBtn) {
        weekProfileBtn.addEventListener("click", async () => {
            const word = weekProfileBtn.dataset.weekAudio;
            if (!word) return;
            const res = await fetch(`/tts?word=${encodeURIComponent(word)}`, { credentials: "include" });
            const data = await res.json();
            if (data?.url) {
                const audio = new Audio(data.url);
                audio.play().catch(() => {});
            }
        });
    }
</script>
{% endblock %}
